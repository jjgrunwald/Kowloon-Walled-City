<!DOCTYPE html>
<html lang="en">
<head>
  <title>Walled City - by JJ Grunwald</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
  <link type="text/css" rel="stylesheet" href="data/main.css">
  <style>
    body { margin: 0; }
      </style>
    </head>
    <body>
      <div id="info">Walled City</div>
      <div id="details">Coding and Models by J.J. Grunwald</div>
      <div id="instructions">PRESS REFRESH TO REGENERATE CITY</div>

      <script type="importmap">
        {
          "imports": {
            "three": "./build/three.module.js",
            "three/addons/": "./data/jsm/"
          }
        }
      </script>

    <script type="module">
      import * as THREE from './build/three.module.js';
      import { OrbitControls } from './data/jsm/controls/OrbitControls.js';
      import { GLTFLoader } from './data/jsm/loaders/GLTFLoader.js';

    class KowloonWalledCity {
      constructor() {
        this._Initialize();
      }

      _Initialize() {
        this._threejs = new THREE.WebGLRenderer({
          antialias: true,
        });
        this._threejs.shadowMap.enabled = true;
        this._threejs.shadowMap.type = THREE.PCFSoftShadowMap;
        this._threejs.setPixelRatio(window.devicePixelRatio);
        this._threejs.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(this._threejs.domElement);

        window.addEventListener('resize', () => {
          this._OnWindowResize();
        }, false);

        const fov = 60;
        const aspect = window.innerWidth / window.innerHeight;
        const near = 1.0;
        const far = 1000.0;
        this._camera = new THREE.PerspectiveCamera(fov, aspect, near, far);
        this._camera.position.set(154.17, 178.53, 134.24);

        this._scene = new THREE.Scene();

        let light = new THREE.DirectionalLight(0xFFFFFF, 4.0);
        light.position.set(20, 80, 10);
        light.target.position.set(0, 0, 0);
        light.castShadow = true;
        light.shadow.bias = -0.001;
        light.shadow.mapSize.width = 2048;
        light.shadow.mapSize.height = 2048;
        light.shadow.camera.near = 0.1;
        light.shadow.camera.far = 500.0;
        light.shadow.camera.left = 100;
        light.shadow.camera.right = -100;
        light.shadow.camera.top = 100;
        light.shadow.camera.bottom = -100;
        this._scene.add(light);

        light = new THREE.AmbientLight(0x101010);
        this._scene.add(light);

        const backColor = new THREE.Color(0xA7EBF2);
        this._scene.background = backColor;

        this._controls = new OrbitControls(this._camera, this._threejs.domElement);
        this._controls.target.set(90, 180, 0);
        this._controls.update();
        const loader = new GLTFLoader();
        loader.load('./data/models/apartment_unit.glb', (gltf) => {
          const model = gltf.scene;
          model.scale.set(1.5, 1.5, 1.5);

          const materials = [
            new THREE.MeshStandardMaterial({ color: 0xADD8E6 }), // Light Blue
            new THREE.MeshStandardMaterial({ color: 0xff00ff }), // Pink
            new THREE.MeshStandardMaterial({ color: 0x77dd77 })  // Pastel Green
          ];

          const rows = 30;
          const cols = 22;
          const xSpacing = 27;
          const ySpacing = 13.5;
          const xOffset = -320;

          for (let i = 0; i < rows; i++) {
            for (let j = 0; j < cols; j++) {
              const clone = model.clone();

              const randomMaterial = materials[Math.floor(Math.random() * materials.length)];

              // Traverse the clone to apply the random material to both window frames
              clone.traverse((child) => {
                if (child.isMesh) {
                  if (child.name === 'Window_Frame_Left' || child.name === 'Window_Frame_Right') {
                    child.material = randomMaterial;
                  }
                }
              });

              clone.position.set(j * xSpacing + xOffset, i * ySpacing, 0);
              this._scene.add(clone);
            }
          }
        }, undefined, (error) => {
          console.error('An error occurred while loading the model:', error);
        });

        this.cameraRadius = 100;
        this.cameraAngle = 0;
        this.isRotating = false;

        this._RAF();
      }

      _OnWindowResize() {
        this._camera.aspect = window.innerWidth / window.innerHeight;
        this._camera.updateProjectionMatrix();
        this._threejs.setSize(window.innerWidth, window.innerHeight);
      }

      _RAF() {
        requestAnimationFrame(() => {
          if (this.isRotating) {
            this.cameraAngle += 0.001;
            this._camera.position.x = this.cameraRadius * Math.cos(this.cameraAngle);
            this._camera.position.z = this.cameraRadius * Math.sin(this.cameraAngle);
            this._camera.position.y = 20;
          }

          this._camera.lookAt(new THREE.Vector3(10, 1, 0));
          this._controls.update();
          this._threejs.render(this._scene, this._camera);
          this._RAF();
        });
      }
    }

    let _APP = null;

    window.addEventListener('DOMContentLoaded', () => {
      _APP = new KowloonWalledCity();
    });
  </script>
</body>
</html>
